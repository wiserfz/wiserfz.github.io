<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://wiserfz.github.io name=base><title>
            
                tower balance
            
        </title><meta content="tower balance" property=og:title><meta content="Balance policy in tower crate." property=og:description><meta content="Balance policy in tower crate." name=description><link href=https://wiserfz.github.io/img/favicons/favicon.ico rel=icon type=image/png><link href=https://wiserfz.github.io/fonts.css rel=stylesheet><script defer src=https://wiserfz.github.io/js/codeblock.js></script><script defer src=https://wiserfz.github.io/js/toc.js></script><script>MathJax = {
                    tex: {
                        inlineMath: [
                            ['$', '$'],
                            ['\\(', '\\)']
                        ]
                    }
                };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link title="
    wiser's blog
" href=https://wiserfz.github.io/atom.xml rel=alternate type=application/atom+xml><link title="
    wiser's blog
" href=https://wiserfz.github.io/rss.xml rel=alternate type=application/rss+xml><link href=https://wiserfz.github.io/theme/light.css rel=stylesheet><link href=https://wiserfz.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://wiserfz.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://wiserfz.github.io/main.css media=screen rel=stylesheet><script src="https://wiserfz.github.io/search_index.en.js?h=83f808dfc552363cb1ef" defer></script><script src="https://wiserfz.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=left-content></div><div class=content><nav><div class=left-nav><a href=https://wiserfz.github.io>wiser's blog</a><div class=socials><a rel="'me" target="'_blank'" class=social href=https://wiserfz.github.io/rss.xml noopener&#x27;> <img alt=rss src=https://wiserfz.github.io/icons/social/rss.svg> </a><a rel="'me" target="'_blank'" class=social href=mailto:wiserfz810@gmail.com noopener&#x27;> <img alt=email src=https://wiserfz.github.io/icons/social/email.svg> </a><a rel="'me" target="'_blank'" class=social href=https://github.com/wiserfz/ noopener&#x27;> <img alt=github src=https://wiserfz.github.io/icons/social/github.svg> </a></div></div><div class=right-nav><a href=https://wiserfz.github.io style=margin-right:.5em>/home</a><a href=https://wiserfz.github.io/posts style=margin-right:.5em>/posts</a><a href=https://wiserfz.github.io/tags style=margin-right:.5em>/tags</a><a href=https://wiserfz.github.io/about style=margin-right:.5em>/about</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://wiserfz.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://wiserfz.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://wiserfz.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></div></nav><div data-selector="main article p" class=visible-element-observer-root><main><article><div class=title><div class=page-header>tower balance</div><div class=meta>Posted on <time>2024-12-14</time><span class=tags-label>::</span><span class=tags> <a class=post-tag href=https://wiserfz.github.io/tags/tower/>tower</a> <a class=post-tag href=https://wiserfz.github.io/tags/code/>code</a> </span></div></div><section class=body><h2 id=qian-yan><a aria-label="Anchor link for: qian-yan" class=zola-anchor href=#qian-yan>å‰è¨€</a></h2><p>åœ¨ä¹‹å‰åˆ†æ tonic çš„<a href=/posts/client-of-grpc-in-rust/>æ–‡ç« </a>ä¸­ï¼Œç”±äº <code>tonic</code> ä¸­å¤§é‡ä½¿ç”¨çš„ <code>tower</code> åº“ä¸­çš„ç»„ä»¶ï¼Œå¹¶ä¸”æ²¡æœ‰åˆ†æ <code>tonic</code> ä¸­çš„ balance ç­–ç•¥ï¼Œç›¸å½“äºè¿˜æœ‰ä¸€éƒ¨åˆ†çš„ä¸œè¥¿æ˜¯ç¼ºå¤±çš„ï¼Œå› æ­¤ï¼›åœ¨è¿™ç¯‡æ–‡ç« ä¸­è¡¥å…¨ã€‚<h2 id=Overview><a aria-label="Anchor link for: Overview" class=zola-anchor href=#Overview>æ¦‚è¿°</a></h2><p>ä» <a href=https://docs.rs/tower/latest/tower/ rel=noopener target=_blank><code>tower</code></a> æ–‡æ¡£çš„æ¦‚è¿°ä¸­ï¼Œå°±å¯ä»¥å¾—çŸ¥ <code>tower</code> ä¸ºç½‘ç»œè¯·æ±‚çš„å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯æä¾›äº†æ¨¡å—åŒ–å¹¶ä¸”å¯é‡ç”¨çš„å¯é ç»„ä»¶ï¼›è€Œè¿™äº›ç»„ä»¶çš„æ ¸å¿ƒå°±æ˜¯ <code>Service</code> traitã€‚<p><code>tower</code> åº“åŒ…å«å››ä¸ª crates<ul><li>towerï¼šè´Ÿè´£ç»„ä»¶çš„å®ç°é€»è¾‘<li>tower-serviceï¼š<code>Service</code> trait çš„å®šä¹‰<li>tower-layerï¼š<code>Layer</code> trait çš„å®šä¹‰<li>tower-testï¼šé›†æˆæµ‹è¯•æ¨¡å—</ul><p>ä»æ–‡æ¡£ï¼Œå¯ä»¥çŸ¥é“è¦æƒ³äº†è§£ tower ä¸­ç»„ä»¶çš„å®ç°ï¼Œå¿…é¡»å…ˆäº†è§£ <code>Service</code> trait çš„å®šä¹‰ä»¥åŠå¦‚ä½•ä½¿ç”¨ï¼Œå› æ­¤ï¼›è¿™ç¯‡æ–‡ç« ç€é‡äº <code>Service</code> trait ä»¥åŠ <code>balance</code> moduleã€‚<h2 id=service><a aria-label="Anchor link for: service" class=zola-anchor href=#service>Service</a></h2><p>ä» <code>tower</code> çš„æ–‡æ¡£ï¼Œæœ€é†’ç›®çš„ä¸€è¡Œå°±æ˜¯å¯¹ <code>Service</code> trait çš„æè¿°ï¼š<p><strong><code>async fn(request) -> Result&lt;Response, Error></code></strong><p>è¿™å³æ˜¯æè¿° <code>Service</code> trait ä¹Ÿæè¿°ä¸€ä¸ªç½‘ç»œè¯·æ±‚çš„æ¨¡å‹ï¼Œ<code>Service</code> trait ä¸ºå®ç°è¿™ä¸ªè¯·æ±‚æ¨¡å‹åšäº†ä»¥ä¸‹å®šä¹‰ï¼š<pre class=language-rs data-lang=rs style=color:#c0c5ce;background-color:#2b303b><code class=language-rs data-lang=rs><span style=color:#b48ead>pub trait </span><span>Service&lt;Request> {
</span><span>    </span><span style=color:#b48ead>type </span><span>Response;
</span><span>    </span><span style=color:#b48ead>type </span><span>Error;
</span><span>    </span><span style=color:#b48ead>type </span><span>Future: Future&lt;Output = Result&lt;</span><span style=color:#b48ead>Self::</span><span>Response, </span><span style=color:#b48ead>Self::</span><span>Error>>;
</span><span>
</span><span>    </span><span style=color:#65737e>// Required methods
</span><span>    </span><span style=color:#b48ead>fn </span><span style=color:#8fa1b3>poll_ready</span><span>(&</span><span style=color:#b48ead>mut </span><span style=color:#bf616a>self</span><span>, </span><span style=color:#bf616a>cx</span><span>: &</span><span style=color:#b48ead>mut </span><span>Context&lt;'_>) -> Poll&lt;Result&lt;(), </span><span style=color:#b48ead>Self::</span><span>Error>>;
</span><span>    </span><span style=color:#b48ead>fn </span><span style=color:#8fa1b3>call</span><span>(&</span><span style=color:#b48ead>mut </span><span style=color:#bf616a>self</span><span>, </span><span style=color:#bf616a>req</span><span>: Request) -> </span><span style=color:#b48ead>Self::</span><span>Future;
</span><span>}
</span></code></pre><p><code>Service</code> trait å®šä¹‰äº†ä¸‰ä¸ªå…³è”ç±»å‹ï¼ˆassociated typeï¼‰åˆ†åˆ«æ˜¯ <code>Response</code>ï¼Œ<code>Error</code> ä»¥åŠ <code>Future</code>ï¼š<ul><li>Response: è¯·æ±‚è¿”å›çš„å“åº”<li>Errorï¼šè¯·æ±‚å‘ç”Ÿé”™è¯¯è¿”å›çš„ Error<li>Futureï¼šå‘èµ·è¯·æ±‚çš„ Future trait</ul><p>ä»¥åŠå®šä¹‰äº†ä¸¤ä¸ª required methodsã€‚<h3 id=poll-ready><a aria-label="Anchor link for: poll-ready" class=zola-anchor href=#poll-ready>poll_ready</a></h3><p>ä¸€ä¸ªè¯·æ±‚æ˜¯å¦èƒ½å¦å‘é€ï¼Œéœ€è¦æœ‰å¾ˆå¤šæ¡ä»¶ï¼Œæ¯”å¦‚æ“ä½œç³»ç»Ÿçš„ buffer æ˜¯å¦æœ‰ç©ºé—²ï¼Œåœ¨æ¯”å¦‚åº•å±‚è¿æ¥çŠ¶æ€æ˜¯å¦æ­£å¸¸ç­‰ï¼Œè¿™äº›éƒ½æ˜¯éœ€è¦åœ¨æ‰§è¡Œå‘é€è¯·æ±‚å‰æå‰è¿›è¡Œåˆ¤æ–­çš„ï¼Œ<code>poll_ready</code> å°±æ˜¯è¿›è¡Œåˆ¤æ–­è¯·æ±‚èƒ½å¦å‘é€ï¼Œå®ƒä¼šè¿”å›ä»¥ä¸‹ä¸‰ç§æƒ…å†µï¼š<ul><li><code>Poll::Ready(Ok(()))</code>ï¼šè¡¨ç¤ºè¯·æ±‚å¯ä»¥è¢«å‘é€<li><code>Poll::Pending</code>ï¼šè¡¨ç¤ºè¯·æ±‚æš‚æ—¶ä¸èƒ½è¢«å¤„ç†ï¼Œå› ä¸ºåº•å±‚çš„ Service è¿˜å› ä¸ºå„ç§å„æ ·çš„åŸå› è¿˜æ²¡æœ‰å‡†å¤‡å¥½ï¼Œè¿™ä¸ªè¯·æ±‚éœ€è¦è¢«é˜»å¡ä»¥ç­‰å¾… service å‡†å¤‡å¥½<li><code>Poll::Ready(Err(_))</code>ï¼šè¡¨ç¤ºåº•å±‚ service é”™è¯¯ï¼Œå¹¶ä¸”ä¸å¯ä»¥åœ¨è¢«ä½¿ç”¨</ul><p><strong>âš ï¸ æ³¨æ„ï¼š</strong><ol><li>åœ¨å‘é€è¯·æ±‚ä¹‹å‰ï¼Œ<code>poll_ready</code> æ–¹æ³•å¯ä»¥è¢«é‡å¤è°ƒç”¨ï¼Œä½†æ˜¯å¿…é¡»è¿”å› <code>Poll::Ready(Ok(()))</code> æˆ–è€… <code>Poll::Ready(Err(_))</code><li><code>poll_ready</code> æ–¹æ³•è°ƒç”¨å¿…é¡»åœ¨ <code>call</code> æ–¹æ³•è°ƒç”¨ä¹‹å‰ï¼›å› ä¸ºåº•å±‚çš„ Service å¯¹è±¡å¯èƒ½ä¼šè¢«å¤šä¸ªèµ„æºä½¿ç”¨è€…å…±äº«ï¼Œå› æ­¤ä¸èƒ½å‡è®¾ï¼Œåº•å±‚æœåŠ¡ä¸€ç›´éƒ½æ˜¯ Ready çŠ¶æ€ï¼Œå¦‚æœåº•å±‚æœåŠ¡è¢«é‡Šæ”¾æ‰ï¼Œåˆ™è°ƒç”¨çš„å¯¹è±¡ä¹Ÿè¦åŠæ—¶é‡Šæ”¾è¿™ä¸ª <code>Service</code> å¯¹è±¡ï¼Œä¸¾ä¸ªğŸŒ°ï¼šå¦‚æœåº•å±‚è¿æ¥çš„ socket å› ä¸ºæŸç§é”™è¯¯è¢«æ“ä½œç³»ç»Ÿå›æ”¶ï¼Œä½†æ˜¯å› ä¸ºæ²¡æœ‰è°ƒç”¨ <code>poll_ready</code> æ–¹æ³•ï¼Œè€Œç›´æ¥è°ƒç”¨ <code>call</code> æ–¹æ³•è¿™ç§æƒ…å†µã€‚</ol><h3 id=call><a aria-label="Anchor link for: call" class=zola-anchor href=#call>call</a></h3><p>å¼‚æ­¥çš„å¤„ç†è¯·æ±‚ï¼Œå¦‚æœæ²¡æœ‰è°ƒç”¨ <code>poll_ready</code> å°±è°ƒç”¨ <code>call</code> åˆ™æœ‰å¯èƒ½é€ æˆç¨‹åº panic<h2 id=balance><a aria-label="Anchor link for: balance" class=zola-anchor href=#balance>Balance</a></h2><p>ç›®å‰ï¼Œtower ä¸­å®ç°çš„ load balance åªæœ‰ <code>p2c(power of two random choices)</code>ï¼Œåœ¨è¯¥ module ä¸‹é¢æœ‰å››ä¸ª struct çš„å®ç°ï¼š<ul><li>Balanceï¼šp2c load balance<li>MakeBalanceï¼šæ„å»º p2c balance çš„å¯¹è±¡<li>MakeBalanceLayerï¼šé€šè¿‡ Layer trait æ„å»º p2c balance å¯¹è±¡<li>MakeFutureï¼šæ„å»º p2c balance çš„ Future</ul><p>å› æ­¤ï¼Œç€é‡äº†è§£ <code>Balance</code> å¯¹è±¡ä¸­æœ‰å“ªäº›å­—æ®µå£°æ˜ã€‚<pre class=language-rs data-lang=rs style=color:#c0c5ce;background-color:#2b303b><code class=language-rs data-lang=rs><span style=color:#b48ead>pub struct </span><span>Balance&lt;D, Req>
</span><span>where
</span><span>    D: Discover,
</span><span>    D::Key: Hash,
</span><span>{
</span><span>    </span><span style=color:#bf616a>discover</span><span>: D,
</span><span>
</span><span>    </span><span style=color:#bf616a>services</span><span>: ReadyCache&lt;</span><span style=color:#b48ead>D::</span><span>Key, </span><span style=color:#b48ead>D::</span><span>Service, Req>,
</span><span>    </span><span style=color:#bf616a>ready_index</span><span>: Option&lt;</span><span style=color:#b48ead>usize</span><span>>,
</span><span>
</span><span>    </span><span style=color:#bf616a>rng</span><span>: Box&lt;dyn Rng + Send + Sync>,
</span><span>
</span><span>    </span><span style=color:#bf616a>_req</span><span>: PhantomData&lt;Req>,
</span><span>}
</span></code></pre><ul><li>discoverï¼šè¦æ±‚æ˜¯è¦æœ‰å®ç° <code>tower::discover::Discover</code> trait çš„å¯¹è±¡ï¼ŒåŠ¨æ€ç®¡ç†åº•å±‚ Service å¯¹è±¡<li>servicesï¼šåº•å±‚ Services é›†åˆ<li>ready_indexï¼šp2c ç­–ç•¥ pick å¥½çš„ Service index<li>rngï¼šéšæœºå› å­<li>_reqï¼šå…³è”çš„æ³›å‹ Req çš„å£°æ˜å­—æ®µ</ul><p>åœ¨<a href=https://wiserfz.github.io/posts/tower-balance/#Overview>æ¦‚è¿°</a>ä¸­æœ‰è¯´æ˜ï¼Œtower ä¸­å®ç°çš„ç»„ä»¶éƒ½ä»¥ <code>Service</code> trait ä¸ºæ ¸å¿ƒï¼Œå› æ­¤ï¼›<code>Balance</code> å¯¹è±¡å®ç°çš„ <code>Service</code> trait å°±æ˜¯å®é™… p2c ç­–ç•¥å®ç°çš„é€»è¾‘ã€‚<pre class=language-rs data-lang=rs style=color:#c0c5ce;background-color:#2b303b><code class=language-rs data-lang=rs><span style=color:#b48ead>impl</span><span>&lt;D, Req> Service&lt;Req> </span><span style=color:#b48ead>for </span><span>Balance&lt;D, Req>
</span><span style=color:#b48ead>where
</span><span>    D: Discover + Unpin,
</span><span>    </span><span style=color:#b48ead>D::</span><span>Key: Hash + Clone,
</span><span>    </span><span style=color:#b48ead>D::</span><span>Error: Into&lt;crate::BoxError>,
</span><span>    </span><span style=color:#b48ead>D::</span><span>Service: Service&lt;Req> + Load,
</span><span>    &lt;</span><span style=color:#b48ead>D::</span><span>Service as Load>::Metric: std::fmt::Debug,
</span><span>    &lt;</span><span style=color:#b48ead>D::</span><span>Service as Service&lt;Req>>::Error: Into&lt;crate::BoxError>,
</span><span>{
</span><span>    </span><span style=color:#b48ead>type </span><span>Response = &lt;</span><span style=color:#b48ead>D::</span><span>Service as Service&lt;Req>>::Response;
</span><span>    </span><span style=color:#b48ead>type </span><span>Error = </span><span style=color:#b48ead>crate</span><span>::BoxError;
</span><span>    </span><span style=color:#b48ead>type </span><span>Future = future::MapErr&lt;
</span><span>        &lt;</span><span style=color:#b48ead>D::</span><span>Service as Service&lt;Req>>::Future,
</span><span>        </span><span style=color:#b48ead>fn</span><span>(&lt;</span><span style=color:#b48ead>D::</span><span>Service as Service&lt;Req>>::Error) -> crate::BoxError,
</span><span>    >;
</span><span>
</span><span>    </span><span style=color:#b48ead>fn </span><span style=color:#8fa1b3>poll_ready</span><span>(&</span><span style=color:#b48ead>mut </span><span style=color:#bf616a>self</span><span>, </span><span style=color:#bf616a>cx</span><span>: &</span><span style=color:#b48ead>mut </span><span>Context&lt;'_>) -> Poll&lt;Result&lt;(), </span><span style=color:#b48ead>Self::</span><span>Error>> {
</span><span>        </span><span style=color:#65737e>// æ¥æ”¶ä» Discover ä¸­æ”¶åˆ°çš„ Change å¯¹è±¡ï¼ŒåŠ¨æ€ç®¡ç†åº•å±‚ Service
</span><span>        </span><span style=color:#b48ead>let </span><span>_ = </span><span style=color:#bf616a>self</span><span>.</span><span style=color:#96b5b4>update_pending_from_discover</span><span>(cx)?;
</span><span>        </span><span style=color:#65737e>// ä¸æ–­çš„ poll åº•å±‚ Serviceï¼Œå¹¶æŠŠå®ƒä»¬å˜ä¸º ready çŠ¶æ€
</span><span>        </span><span style=color:#bf616a>self</span><span>.</span><span style=color:#96b5b4>promote_pending_to_ready</span><span>(cx);
</span><span>
</span><span>        </span><span style=color:#b48ead>loop </span><span>{
</span><span>            </span><span style=color:#65737e>// p2c load balance å®ç°é€»è¾‘
</span><span>            </span><span style=color:#b48ead>if let </span><span>Some(index) = </span><span style=color:#bf616a>self</span><span>.ready_index.</span><span style=color:#96b5b4>take</span><span>() {
</span><span>                </span><span style=color:#b48ead>match </span><span style=color:#bf616a>self</span><span>.services.</span><span style=color:#96b5b4>check_ready_index</span><span>(cx, index) {
</span><span>                    Ok(</span><span style=color:#d08770>true</span><span>) => {
</span><span>                        </span><span style=color:#65737e>// The service remains ready.
</span><span>                        </span><span style=color:#bf616a>self</span><span>.ready_index = Some(index);
</span><span>                        </span><span style=color:#b48ead>return </span><span>Poll::Ready(Ok(()));
</span><span>                    }
</span><span>                    Ok(</span><span style=color:#d08770>false</span><span>) => {
</span><span>                        </span><span style=color:#65737e>// The service is no longer ready. Try to find a new one.
</span><span>                        trace!("</span><span style=color:#a3be8c>ready service became unavailable</span><span>");
</span><span>                    }
</span><span>                    Err(Failed(_, error)) => {
</span><span>                        </span><span style=color:#65737e>// The ready endpoint failed, so log the error and try
</span><span>                        </span><span style=color:#65737e>// to find a new one.
</span><span>                        debug!(%error, "</span><span style=color:#a3be8c>endpoint failed</span><span>");
</span><span>                    }
</span><span>                }
</span><span>            }
</span><span>
</span><span>            </span><span style=color:#65737e>// Select a new service by comparing two at random and using the
</span><span>            </span><span style=color:#65737e>// lesser-loaded service.
</span><span>            </span><span style=color:#bf616a>self</span><span>.ready_index = </span><span style=color:#bf616a>self</span><span>.</span><span style=color:#96b5b4>p2c_ready_index</span><span>();
</span><span>            </span><span style=color:#b48ead>if </span><span style=color:#bf616a>self</span><span>.ready_index.</span><span style=color:#96b5b4>is_none</span><span>() {
</span><span>                debug_assert_eq!(</span><span style=color:#bf616a>self</span><span>.services.</span><span style=color:#96b5b4>ready_len</span><span>(), </span><span style=color:#d08770>0</span><span>);
</span><span>                </span><span style=color:#65737e>// We have previously registered interest in updates from
</span><span>                </span><span style=color:#65737e>// discover and pending services.
</span><span>                </span><span style=color:#b48ead>return </span><span>Poll::Pending;
</span><span>            }
</span><span>        }
</span><span>    }
</span><span>
</span><span>    </span><span style=color:#b48ead>fn </span><span style=color:#8fa1b3>call</span><span>(&</span><span style=color:#b48ead>mut </span><span style=color:#bf616a>self</span><span>, </span><span style=color:#bf616a>request</span><span>: Req) -> </span><span style=color:#b48ead>Self::</span><span>Future {
</span><span>        </span><span style=color:#b48ead>let</span><span> index = </span><span style=color:#bf616a>self</span><span>.ready_index.</span><span style=color:#96b5b4>take</span><span>().</span><span style=color:#96b5b4>expect</span><span>("</span><span style=color:#a3be8c>called before ready</span><span>");
</span><span>        </span><span style=color:#bf616a>self</span><span>.services
</span><span>            .</span><span style=color:#96b5b4>call_ready_index</span><span>(index, request)
</span><span>            .</span><span style=color:#96b5b4>map_err</span><span>(Into::into)
</span><span>    }
</span><span>}
</span></code></pre><p>ä¸Šè¿°ä»£ç å°±æ˜¯ï¼Œæ•´ä¸ª <code>Balance</code> çš„æ ¸å¿ƒé€»è¾‘äº†ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œå¯¹æ¯” <code>grpc-go</code> ä¸­ balancer çš„å®ç°è¦ç®€æ´å¾ˆå¤šï¼Œè€Œä¸”ä»æˆ‘ä¸ªäººè§’åº¦æ¥çœ‹ä¹Ÿå®ç°çš„æ›´åŠ ä¼˜é›…ï¼Œ<code>grpc-go</code> ä¸­çš„å®ç°è°ƒç”¨ï¼Œåœ¨æˆ‘é˜…è¯»æœŸé—´ç®€ç›´è®©æˆ‘å¤´æ˜è„‘èƒ€ï¼Œä¸å¾—ä¸ç”¨æ—¶åºå›¾æ¥è¡¨æ˜è°ƒç”¨é€»è¾‘ï¼Œå…·ä½“å¯ä»¥çœ‹è¿™ç¯‡<a href=/posts/client-of-grpc-in-go-balancer/>æ–‡ç« </a>ã€‚<h3 id=poll-ready-1><a aria-label="Anchor link for: poll-ready-1" class=zola-anchor href=#poll-ready-1>poll_ready</a></h3><pre class=language-rs data-lang=rs style=color:#c0c5ce;background-color:#2b303b><code class=language-rs data-lang=rs><span style=color:#65737e>/// Polls `discover` for updates, adding new items to `not_ready`.
</span><span style=color:#65737e>///
</span><span style=color:#65737e>/// Removals may alter the order of either `ready` or `not_ready`.
</span><span style=color:#b48ead>fn </span><span style=color:#8fa1b3>update_pending_from_discover</span><span>(
</span><span>    &</span><span style=color:#b48ead>mut </span><span style=color:#bf616a>self</span><span>,
</span><span>    </span><span style=color:#bf616a>cx</span><span>: &</span><span style=color:#b48ead>mut </span><span>Context&lt;'_>,
</span><span>) -> Poll&lt;Option&lt;Result&lt;(), error::Discover>>> {
</span><span>    debug!("</span><span style=color:#a3be8c>updating from discover</span><span>");
</span><span>    </span><span style=color:#b48ead>loop </span><span>{
</span><span>        </span><span style=color:#b48ead>match </span><span>ready!(Pin::new(&</span><span style=color:#b48ead>mut </span><span style=color:#bf616a>self</span><span>.discover).</span><span style=color:#96b5b4>poll_discover</span><span>(cx))
</span><span>            .</span><span style=color:#96b5b4>transpose</span><span>()
</span><span>            .</span><span style=color:#96b5b4>map_err</span><span>(|</span><span style=color:#bf616a>e</span><span>| error::Discover(e.</span><span style=color:#96b5b4>into</span><span>()))?
</span><span>        {
</span><span>            None => </span><span style=color:#b48ead>return </span><span>Poll::Ready(None),
</span><span>            Some(Change::Remove(key)) => {
</span><span>                trace!("</span><span style=color:#a3be8c>remove</span><span>");
</span><span>                </span><span style=color:#bf616a>self</span><span>.services.</span><span style=color:#96b5b4>evict</span><span>(&key);
</span><span>            }
</span><span>            Some(Change::Insert(key, svc)) => {
</span><span>                trace!("</span><span style=color:#a3be8c>insert</span><span>");
</span><span>                </span><span style=color:#65737e>// If this service already existed in the set, it will be
</span><span>                </span><span style=color:#65737e>// replaced as the new one becomes ready.
</span><span>                </span><span style=color:#bf616a>self</span><span>.services.</span><span style=color:#96b5b4>push</span><span>(key, svc);
</span><span>            }
</span><span>        }
</span><span>    }
</span><span>}
</span></code></pre><p>ä¸æ–­çš„ poll <code>Discover</code> å¯¹è±¡å¹¶ä»ä¸­æ¥æ”¶ <code>tower::discover::Change</code> å¯¹è±¡ï¼Œå¦‚æœæ˜¯ <code>Change::Remove</code> åˆ™ä» services é›†åˆä¸­åˆ é™¤åº•å±‚ serviceï¼Œå¦‚æœæ˜¯ <code>Change::Insert</code> åˆ™æŠŠ service åŠ å…¥ services é›†åˆä¸­ã€‚<pre class=language-rs data-lang=rs style=color:#c0c5ce;background-color:#2b303b><code class=language-rs data-lang=rs><span style=color:#b48ead>fn </span><span style=color:#8fa1b3>promote_pending_to_ready</span><span>(&</span><span style=color:#b48ead>mut </span><span style=color:#bf616a>self</span><span>, </span><span style=color:#bf616a>cx</span><span>: &</span><span style=color:#b48ead>mut </span><span>Context&lt;'_>) {
</span><span>    </span><span style=color:#b48ead>loop </span><span>{
</span><span>        </span><span style=color:#b48ead>match </span><span style=color:#bf616a>self</span><span>.services.</span><span style=color:#96b5b4>poll_pending</span><span>(cx) {
</span><span>            Poll::Ready(Ok(())) => {
</span><span>                </span><span style=color:#65737e>// There are no remaining pending services.
</span><span>                debug_assert_eq!(</span><span style=color:#bf616a>self</span><span>.services.</span><span style=color:#96b5b4>pending_len</span><span>(), </span><span style=color:#d08770>0</span><span>);
</span><span>                </span><span style=color:#b48ead>break</span><span>;
</span><span>            }
</span><span>            Poll::Pending => {
</span><span>                </span><span style=color:#65737e>// None of the pending services are ready.
</span><span>                debug_assert!(</span><span style=color:#bf616a>self</span><span>.services.</span><span style=color:#96b5b4>pending_len</span><span>() > </span><span style=color:#d08770>0</span><span>);
</span><span>                </span><span style=color:#b48ead>break</span><span>;
</span><span>            }
</span><span>            Poll::Ready(Err(error)) => {
</span><span>                </span><span style=color:#65737e>// An individual service was lost; continue processing
</span><span>                </span><span style=color:#65737e>// pending services.
</span><span>                debug!(%error, "</span><span style=color:#a3be8c>dropping failed endpoint</span><span>");
</span><span>            }
</span><span>        }
</span><span>    }
</span><span>    trace!(
</span><span>        ready = %</span><span style=color:#bf616a>self</span><span>.services.</span><span style=color:#96b5b4>ready_len</span><span>(),
</span><span>        pending = %</span><span style=color:#bf616a>self</span><span>.services.</span><span style=color:#96b5b4>pending_len</span><span>(),
</span><span>        "</span><span style=color:#a3be8c>poll_unready</span><span>"
</span><span>    );
</span><span>}
</span></code></pre><p><code>promote_pending_to_ready</code> æ–¹æ³•ä¸æ–­çš„ poll services é›†åˆï¼›<ul><li>è¿”å› <code>Poll::Ready(Ok(()))</code>ï¼šè¡¨ç¤ºåº•å±‚æœ‰å¯ç”¨çš„ service å¹¶è¿”å›<li>è¿”å› <code>Poll::Pending</code>ï¼šè¡¨ç¤ºåº•å±‚çš„æ‰€æœ‰ service éƒ½ä¸å¯ç”¨ï¼Œé˜»å¡è°ƒç”¨ï¼Œç­‰å¾… Event äº‹ä»¶å”¤é†’ï¼Œå¹¶ç»§ç»­ poll services é›†åˆï¼ŒçŸ¥é“æœ‰å¯ç”¨ service è¿”å›<li>è¿”å› <code>Poll::Ready(Err(_))</code>ï¼šè¡¨ç¤ºè¯¥ service å†…éƒ¨å‡ºé”™ï¼Œä¸å¯ç”¨ï¼›ç»§ç»­ poll ä¸‹ä¸€ä¸ª service</ul><p>ç„¶åï¼Œé€šè¿‡ p2c ç­–ç•¥ä» services é›†åˆä¸­çš„ ready å¯¹è±¡é›†åˆä¸­è·å–ä¸€ä¸ª service å¹¶æŠŠè¿™ä¸ª service çš„ index å­˜å…¥ <code>ready_index</code> å­—æ®µä¸­ï¼Œä¸º <code>call</code> è°ƒç”¨åšå‡†å¤‡<h3 id=call-1><a aria-label="Anchor link for: call-1" class=zola-anchor href=#call-1>call</a></h3><p>é€šè¿‡ <code>poll_ready</code> æ–¹æ³•è°ƒç”¨ï¼Œå¯ç”¨çš„ service çš„ index å·²ç»å­˜åœ¨ <code>ready_index</code> å­—æ®µä¸­ï¼Œä»ä¸­å–å‡º index å¹¶é€šè¿‡ <code>self.services.call_ready_index</code> å‘é€è¯·æ±‚ï¼Œç­‰å¾…å“åº”ã€‚<h2 id=readycache><a aria-label="Anchor link for: readycache" class=zola-anchor href=#readycache>ReadyCache</a></h2><p>ä¸Šè¿°ä¸­ services é›†åˆæ˜¯åˆ©ç”¨çš„ <code>tower::ready_cache::ReadyCache</code> å¯¹è±¡ã€‚<pre class=language-rs data-lang=rs style=color:#c0c5ce;background-color:#2b303b><code class=language-rs data-lang=rs><span style=color:#b48ead>pub struct </span><span>ReadyCache&lt;K, S, Req>
</span><span>where
</span><span>    K: Eq + Hash,
</span><span>{
</span><span>    </span><span style=color:#bf616a>pending</span><span>: FuturesUnordered&lt;Pending&lt;K, S, Req>>,
</span><span>
</span><span>    </span><span style=color:#bf616a>pending_cancel_txs</span><span>: IndexMap&lt;K, CancelTx>,
</span><span>
</span><span>    </span><span style=color:#bf616a>ready</span><span>: IndexMap&lt;K, (S, CancelPair)>,
</span><span>}
</span></code></pre><ul><li><code>pending</code>ï¼š<code>FuturesUnordered</code> æ˜¯ä¸€ä¸ªå®ç° <code>Stream</code> trait çš„å¯¹è±¡ï¼Œæš‚æ—¶ä¸å¯ç”¨çš„ service é›†åˆ<li><code>pending_cancel_txs</code>ï¼šå½“ service ä¸å¯ç”¨æˆ–è€…è¢«åˆ é™¤æ—¶ï¼Œé€šè¿‡ <code>CancelTx</code> åˆ é™¤ service<li><code>ready</code>ï¼šå¯ç”¨çš„ service é›†åˆ</ul><p>å½“ä¸€ä¸ªæ–°çš„ service é€šè¿‡ <code>update_pending_from_discover</code> æ–¹æ³•ä¸­çš„ <code>self.services.push(key, svc)</code> æ–¹æ³•è°ƒç”¨ï¼Œä¼šè¢«ç»Ÿä¸€åŠ å…¥åˆ° <code>pending</code> å¯¹è±¡ä¸­ï¼Œå› æ­¤ï¼›è°ƒç”¨ <code>self.services.poll_pending</code> æ–¹æ³•ï¼Œä¼š poll <code>pending</code> ä¸­çš„æ¯ä¸€ä¸ªå¯¹è±¡ã€‚<pre class=language-rs data-lang=rs style=color:#c0c5ce;background-color:#2b303b><code class=language-rs data-lang=rs><span style=color:#b48ead>pub fn </span><span style=color:#8fa1b3>poll_pending</span><span>(&</span><span style=color:#b48ead>mut </span><span style=color:#bf616a>self</span><span>, </span><span style=color:#bf616a>cx</span><span>: &</span><span style=color:#b48ead>mut </span><span>Context&lt;'_>) -> Poll&lt;Result&lt;(), error::Failed&lt;K>>> {
</span><span>    </span><span style=color:#b48ead>loop </span><span>{
</span><span>        </span><span style=color:#b48ead>match </span><span>Pin::new(&</span><span style=color:#b48ead>mut </span><span style=color:#bf616a>self</span><span>.pending).</span><span style=color:#96b5b4>poll_next</span><span>(cx) {
</span><span>            Poll::Pending => </span><span style=color:#b48ead>return </span><span>Poll::Pending,
</span><span>            Poll::Ready(None) => </span><span style=color:#b48ead>return </span><span>Poll::Ready(Ok(())),
</span><span>            Poll::Ready(Some(Ok((key, svc, cancel_rx)))) => {
</span><span>                trace!("</span><span style=color:#a3be8c>endpoint ready</span><span>");
</span><span>                </span><span style=color:#b48ead>let</span><span> cancel_tx = </span><span style=color:#bf616a>self</span><span>.pending_cancel_txs.</span><span style=color:#96b5b4>swap_remove</span><span>(&key);
</span><span>                </span><span style=color:#b48ead>if let </span><span>Some(cancel_tx) = cancel_tx {
</span><span>                    </span><span style=color:#65737e>// Keep track of the cancelation so that it need not be
</span><span>                    </span><span style=color:#65737e>// recreated after the service is used.
</span><span>                    </span><span style=color:#bf616a>self</span><span>.ready.</span><span style=color:#96b5b4>insert</span><span>(key, (svc, (cancel_tx, cancel_rx)));
</span><span>                } </span><span style=color:#b48ead>else </span><span>{
</span><span>                    assert!(
</span><span>                        cancel_tx.</span><span style=color:#96b5b4>is_some</span><span>(),
</span><span>                        "</span><span style=color:#a3be8c>services that become ready must have a pending cancelation</span><span>"
</span><span>                    );
</span><span>                }
</span><span>            }
</span><span>            Poll::Ready(Some(Err(PendingError::Canceled(_)))) => {
</span><span>                debug!("</span><span style=color:#a3be8c>endpoint canceled</span><span>");
</span><span>                </span><span style=color:#65737e>// The cancellation for this service was removed in order to
</span><span>                </span><span style=color:#65737e>// cause this cancellation.
</span><span>            }
</span><span>            Poll::Ready(Some(Err(PendingError::Inner(key, e)))) => {
</span><span>                </span><span style=color:#b48ead>let</span><span> cancel_tx = </span><span style=color:#bf616a>self</span><span>.pending_cancel_txs.</span><span style=color:#96b5b4>swap_remove</span><span>(&key);
</span><span>                assert!(
</span><span>                    cancel_tx.</span><span style=color:#96b5b4>is_some</span><span>(),
</span><span>                    "</span><span style=color:#a3be8c>services that return an error must have a pending cancelation</span><span>"
</span><span>                );
</span><span>                </span><span style=color:#b48ead>return </span><span>Err(error::Failed(key, e.</span><span style=color:#96b5b4>into</span><span>())).</span><span style=color:#96b5b4>into</span><span>();
</span><span>            }
</span><span>        }
</span><span>    }
</span><span>}
</span></code></pre><p>poll æ¯ä¸ªå…¶ä¸­çš„ servicer å¯¹è±¡åªä¼šè¿”å›ä»¥ä¸‹ç»“æœï¼š<ul><li><code>Poll::Pending</code>ï¼šè¯¥æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œå› æ­¤ç»§ç»­ç•™åœ¨ <code>pending</code> ä¸­<li><code>Poll::Ready(None)</code>ï¼šè¡¨ç¤º <code>pending</code> é›†åˆä¸­æ²¡æœ‰ service å¯¹è±¡äº†<li><code>Poll::Ready(Ok(_))</code>ï¼šè¡¨ç¤ºè¯¥ service å·²ç»å¤„äº ready çŠ¶æ€ï¼Œå¯ä»¥å‘é€è¯·æ±‚äº†ï¼Œå¹¶æŠŠå®ƒåŠ å…¥åˆ° <code>ready</code> é›†åˆä¸­<li><code>Poll::Ready(Err(_))</code>: è¿™é‡ŒæŠŠ Error åˆ†æˆä¸¤ç§ç±»å‹ï¼Œä¸€ç§æ˜¯ <code>PendingError::Canceled</code> è¡¨ç¤ºå·²ç»è¢« cancel æ‰çš„ serviceï¼Œservice å·²ç»è¢«åˆ é™¤æ‰äº†ï¼Œå› æ­¤è¿™é‡Œå¿½ç•¥ï¼›å¦ä¸€ç§é”™è¯¯æ˜¯ <code>PendingError::Inner</code>ï¼Œè¿™é‡Œè¡¨ç¤º service å†…éƒ¨é”™è¯¯ï¼Œä¸èƒ½è¢«å¿½ç•¥å¤„ç†ï¼Œéœ€è¦è°ƒç”¨ CancelTxï¼Œå¹¶æŠŠ service cancel æ‰</ul><p>è¿™æ ·ï¼Œå°±æŠŠæ‰€æœ‰å¤„äº <code>pending</code> é›†åˆä¸­çš„ service éƒ½å¤„ç†äº†ä¸€è¾¹ï¼Œå¹¶æŠŠå¯ç”¨çš„ service åŠ å…¥åˆ° <code>ready</code> é›†åˆä¸­ï¼Œæš‚æ—¶ä¸å¯ç”¨çš„ service ç»§ç»­ç•™åœ¨ <code>pending</code> ä¸­ï¼Œå‘ç”Ÿé”™è¯¯çš„ service è¿›è¡Œ cancel å¤„ç†ã€‚<pre class=language-rs data-lang=rs style=color:#c0c5ce;background-color:#2b303b><code class=language-rs data-lang=rs><span style=color:#65737e>/// Calls a ready service by index.
</span><span style=color:#65737e>///
</span><span style=color:#65737e>/// # Panics
</span><span style=color:#65737e>///
</span><span style=color:#65737e>/// If the specified index is out of range.
</span><span style=color:#b48ead>pub fn </span><span style=color:#8fa1b3>call_ready_index</span><span>(&</span><span style=color:#b48ead>mut </span><span style=color:#bf616a>self</span><span>, </span><span style=color:#bf616a>index</span><span>: </span><span style=color:#b48ead>usize</span><span>, </span><span style=color:#bf616a>req</span><span>: Req) -> </span><span style=color:#b48ead>S::</span><span>Future {
</span><span>    </span><span style=color:#b48ead>let </span><span>(key, (</span><span style=color:#b48ead>mut</span><span> svc, cancel)) = </span><span style=color:#bf616a>self
</span><span>        .ready
</span><span>        .</span><span style=color:#96b5b4>swap_remove_index</span><span>(index)
</span><span>        .</span><span style=color:#96b5b4>expect</span><span>("</span><span style=color:#a3be8c>check_ready_index was not called</span><span>");
</span><span>
</span><span>    </span><span style=color:#b48ead>let</span><span> fut = svc.</span><span style=color:#96b5b4>call</span><span>(req);
</span><span>
</span><span>    </span><span style=color:#65737e>// If a new version of this service has been added to the
</span><span>    </span><span style=color:#65737e>// unready set, don't overwrite it.
</span><span>    </span><span style=color:#b48ead>if </span><span>!</span><span style=color:#bf616a>self</span><span>.</span><span style=color:#96b5b4>pending_contains</span><span>(&key) {
</span><span>        </span><span style=color:#bf616a>self</span><span>.</span><span style=color:#96b5b4>push_pending</span><span>(key, svc, cancel);
</span><span>    }
</span><span>
</span><span>    fut
</span><span>}
</span></code></pre><p><code>call_ready_index</code> æ–¹æ³•ä¼šé€šè¿‡ index ä» <code>ready</code> é›†åˆä¸­è·å– service å¹¶è°ƒç”¨è¯¥ service çš„ <code>Service.Call</code> æ–¹æ³•ï¼Œå¹¶è¿”å› <code>Service</code> trait ä¸­å®šä¹‰çš„å…³è”ç±»å‹ Futureï¼Œè®©è°ƒç”¨è€…é€šè¿‡ <code>await</code> è·å– Responseã€‚<p>åŒæ—¶ï¼Œä¼šæŠŠä» ready é›†åˆä¸­å–å‡ºçš„ service å¯¹è±¡ï¼ŒåŠ å…¥åˆ° <code>pending</code> é›†åˆä¸­ï¼Œè¿™æ ·ç­‰å¾…ï¼Œä¸‹ä¸€æ¬¡çš„è°ƒç”¨ï¼›å¦‚æœè¯¥ service ç»§ç»­å¯ä»¥ä½¿ç”¨ï¼Œé‚£ä¹ˆå°±åœ¨æŠŠå®ƒä» <code>pending</code> é›†åˆåœ¨åŠ å…¥åˆ° <code>ready</code> é›†åˆä¸­ï¼Œé€šè¿‡ä» <code>pending</code> -> <code>ready</code>ï¼Œä»¥åŠ <code>ready</code> -> <code>pending</code> è¿™æ ·çš„å¾ªç¯è°ƒç”¨ï¼Œå®ç°æœåŠ¡è¯·æ±‚çš„å¯é ä½¿ç”¨ã€‚</section></article></main></div></div><div class=right-content><div class=toc><div class=heading>Table of Contents</div><ul class=toc-list><li class=parent><a href=https://wiserfz.github.io/posts/tower-balance/#qian-yan>å‰è¨€</a><li class=parent><a href=https://wiserfz.github.io/posts/tower-balance/#Overview>æ¦‚è¿°</a><li class=parent><a href=https://wiserfz.github.io/posts/tower-balance/#service>Service</a> <ul><li><a href=https://wiserfz.github.io/posts/tower-balance/#poll-ready>poll_ready</a><li><a href=https://wiserfz.github.io/posts/tower-balance/#call>call</a></ul><li class=parent><a href=https://wiserfz.github.io/posts/tower-balance/#balance>Balance</a> <ul><li><a href=https://wiserfz.github.io/posts/tower-balance/#poll-ready-1>poll_ready</a><li><a href=https://wiserfz.github.io/posts/tower-balance/#call-1>call</a></ul><li class=parent><a href=https://wiserfz.github.io/posts/tower-balance/#readycache>ReadyCache</a></ul></div></div>